<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡”ç¾…å åœ (è³‡æ–™åº«æ•´åˆç‰ˆ)</title>
   <style>
        :root {
            --card-w: 120px;
            --card-h: 210px;
        }

        body {
            background-color: #0e0e0e;
            color: #d4af37;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* æ¡Œé¢ç‰ˆæ§åˆ¶åˆ— (ä¿æŒä¸€æ’) */
        .controls {
            position: absolute;
            bottom: 30px;
            display: flex;
            gap: 10px;
            z-index: 999;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 30px;
            flex-wrap: wrap;
            justify-content: center;
            width: auto;
            max-width: 90%;
        }

        select, button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #d4af37;
            color: #d4af37;
            border-radius: 5px;
            outline: none;
        }

        button:disabled {
            border-color: #555;
            color: #555;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            background: #d4af37;
            color: #000;
        }

        /* --- â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆå°ˆå±¬å„ªåŒ–å€ â˜…â˜…â˜… --- */
        @media (max-width: 600px) {
            :root {
                /* 1. å°‡å¡ç‰‡åŸºç¤å°ºå¯¸ç¸®å° 30% */
                --card-w: 80px; 
                --card-h: 140px;
            }

            .controls {
                bottom: 10px;
                padding: 10px;
                width: 95%;
                border-radius: 15px;
                /* æ”¹ç‚º Grid ä½ˆå±€ï¼Œè®“æŒ‰éˆ•æ•´é½Šæ’åˆ— */
                display: grid;
                grid-template-columns: 1fr 1fr; /* å…©æ¬„ */
                gap: 8px; 
            }

            /* è®“é¢å‘é¸æ“‡ (ç¶œåˆé‹å‹¢) ä½”æ»¿æ•´è¡Œï¼Œå­—æ‰ä¸æœƒè¢«åˆ‡æ‰ */
            #categorySelector {
                grid-column: 1 / -1; 
                text-align-last: center; /* æ–‡å­—ç½®ä¸­ */
            }

            /* åŸºç¤èˆ‡é€²éšå„ä½”ä¸€åŠ */
            #spreadBasic, #spreadAdv {
                width: 100%;
                font-size: 13px; /* å­—é«”é©ä¸­ */
            }

            /* æŒ‰éˆ•å€ä¹Ÿä½”æ»¿æ•´è¡Œ */
            #btnShuffle, #btnSpread, #btnReset {
                grid-column: 1 / -1;
                width: 100%;
                padding: 12px;
                font-weight: bold;
            }
        }

        /* ä»¥ä¸‹ä¿æŒåŸæœ‰æ¨£å¼ */
        #tableArea {
            position: relative;
            width: 100%;
            height: 100%;
            perspective: 1000px;
            overflow: hidden;
        }

        .card {
            width: var(--card-w);
            height: var(--card-h);
            position: absolute;
            top: 50%;
            left: 50%;
            transform-style: preserve-3d;
            transform: translate(-50%, -50%);
            transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            border: 2px solid #d4af37;
            background-color: #1a1a1a;
            box-sizing: border-box; 
        }

        .front {
            background: repeating-linear-gradient(
                45deg,
                #1a1a1a,
                #1a1a1a 10px,
                #222 10px,
                #222 20px
            );
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .front::after {
            content: "âœ¦";
            font-size: 40px;
            color: #555;
        }

        .back {
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column; 
            background: #000;
            overflow: hidden; 
        }

        .back-img-container {
            flex: 1; 
            width: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .back-img-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
        }

        .back-text {
            height: auto; 
            min-height: 40px; 
            background: rgba(0,0,0,0.9);
            border-top: 1px solid #d4af37;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4px;
            box-sizing: border-box;
        }

        .card-name-text {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            width: 100%; 
        }

        #statusText {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            font-size: 1.2em;
            text-shadow: 0 2px 4px black;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.5s;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: #1a1a1a;
            border: 2px solid #d4af37;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        .close-btn {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }
        .modal-header {
            font-size: 1.5em;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            color: #d4af37;
        }
        .detail-btn {
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            background: #d4af37;
            color: #000;
            border: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="hint" id="statusText">è«‹æº–å‚™é–‹å§‹å„€å¼</div>
    <div class="table-area" id="tableArea"></div>

<div class="controls">
    <select id="categorySelector">
        <option value="general">ğŸ”® ç¶œåˆé‹å‹¢</option>
        <option value="love">â¤ï¸ æ„›æƒ…æƒ…æ„Ÿ</option>
        <option value="work">ğŸ’¼ å·¥ä½œäº‹æ¥­</option>
        <option value="finance">ğŸ’° è²¡å‹™é‡‘éŒ¢</option>
        <option value="academic">ğŸ“ å­¸æ¥­è€ƒè©¦</option>
        <option value="friendship">ğŸ¤ äººéš›é—œä¿‚</option>
        <option value="family">ğŸ  å®¶åº­è¦ªæƒ…</option>
    </select>

    <select id="spreadBasic" onchange="changeSpread('basic')">
        <option value="" disabled selected>ğŸ”° åŸºç¤ç‰Œé™£</option>
        <option value="single">å–®å¼µç‰Œ (æ¯æ—¥æŒ‡å¼•)</option>
        <option value="time">æ™‚é–“ä¹‹æµ (éå»/ç¾åœ¨/æœªä¾†)</option>
	<option value="happiness">å¹¸ç¦æŒ‡æ•¸ (æœ¬æœˆé‹å‹¢)</option>
        <option value="self">è‡ªæˆ‘æ¢ç´¢ (äº†è§£è‡ªå·±çš„å…§å¿ƒ)</option>
	<option value="find_partner">å°‹æ‰¾å°è±¡å åœæ³•</option>
        <option value="choice">äºŒæ“‡ä¸€ (å…©é›£é¸æ“‡)</option>
	<option value="friendship">å‹èª¼å åœ (é›™æ–¹çœ‹æ³•)</option> </select>
    </select>

    <select id="spreadAdv" onchange="changeSpread('adv')">
        <option value="" disabled selected>âœ¨ é€²éšç‰Œé™£</option>
        <option value="hexagram">å…­èŠ’æ˜Ÿ (å…¨æ–¹ä½)</option>
        <option value="love_real">æ„›æƒ…çœŸå¿ƒ (äº†è§£è‡ªå·±å’Œå°æ–¹çš„å¿ƒæ„)</option>
        <option value="lovers_pyramid">æˆ€äººé‡‘å­—å¡” (å…©äººç™¼å±•çš„å¯èƒ½æ€§)</option> 
        <option value="celtic">å…‹çˆ¾ç‰¹åå­— (å°‹æ‰¾å•é¡ŒçœŸæ­£æ‰€åœ¨)</option>
	<option value="future">æœªä¾†ç™¼å±•å åœæ³•</option>
	<option value="karmic">å¡çˆ¾ç±³å…‹ (æ¢è¨è‡ªå·±çš„å‘½é‹)</option>
    </select>
    <button id="btnShuffle" onclick="startRitual()">æ´—ç‰Œ</button>
    <button id="btnSpread" onclick="spreadDeck()" disabled>å±•é–‹</button>
    <button id="btnReset" onclick="resetGame()" style="display:none; border-color: #fff; color: #fff;">é‡ç½®</button>
</div>

    <div class="modal-overlay" id="meaningModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ç‰Œå</div>
                <div class="modal-subtitle" id="modalStatus">æ­£ä½ / é€†ä½</div>
            </div>
            <div class="modal-body">
                <div id="mainView">
                    <div class="image-desc-box">
                        <strong style="color: #d4af37;">ã€ç‰Œé¢åœ–è§£ã€‘</strong><br>
                        <span id="imageDescText">...</span>
                    </div>
                    <p style="text-align: center; color: #aaa; margin-bottom: 10px;">è«‹é¸æ“‡æƒ³äº†è§£çš„é¢å‘ï¼š</p>
                    <div class="category-grid">
                        <button class="cat-btn" onclick="showDetail('character')">ğŸ‘¤ äººç‰©</button>
                        <button class="cat-btn" onclick="showDetail('work')">ğŸ’¼ å·¥ä½œ</button>
                        <button class="cat-btn" onclick="showDetail('love')">â¤ï¸ æ„›æƒ…</button>
                        <button class="cat-btn" onclick="showDetail('friendship')">ğŸ¤ å‹æƒ…</button>
                        <button class="cat-btn" onclick="showDetail('family')">ğŸ  è¦ªæƒ…</button>
                        <button class="cat-btn" onclick="showDetail('academic')">ğŸ“ å­¸æ¥­</button>
                        <button class="cat-btn" onclick="showDetail('finance')">ğŸ’° è²¡å‹™</button>
                    </div>
                </div>
                <div id="detailView" class="detail-view">
                    <div class="detail-title" id="detailTitle">é¡åˆ¥æ¨™é¡Œ</div>
                    <div class="detail-content" id="detailContent">å…§å®¹...</div>
                    <button class="back-btn" onclick="backToMain()">â¬… è¿”å›é¸å–®</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-close" onclick="closeModal()">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>

    <script src="tarot-data.js"></script>
<script>
    // --- è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸ ---
    const TOTAL_CARDS = 78;
    let cardsDOM = [];
    let isSpread = false;
    let hasDrawn = false;
    let isAnimating = false; 
    let currentResult = null;
    let activeCardData = null;
    let activeIsReversed = false;
    let shuffledDeck = []; 

    // --- 1. å®šç¾©ç‰Œé™£è³‡æ–™ (å®Œæ•´ç‰ˆ) ---
    const SPREAD_DATA = {
        // === åŸºç¤ç‰Œé™£ ===
        'happiness': {
            name: "å¹¸ç¦æŒ‡æ•¸å åœæ³•",
            positions: [
                "æœ¬é€±é‹ç¨‹", 
                "ä¸‹é€±é‹ç¨‹", 
                "ç¬¬ä¸‰é€±é‹ç¨‹", 
                "ç¬¬å››é€±é‹ç¨‹", 
                "ç¬¬äº”é€±é‹ç¨‹"
            ],
            // æ’åˆ—ï¼šæ©«å‘ä¸€å­—æ’é–‹ï¼Œåˆ†ç‚ºäº”é€±
            layout: [
                {x: -240, y: 0},   // 1. ç¬¬ä¸€é€± (æœ€å·¦)
                {x: -120, y: 0},   // 2. ç¬¬äºŒé€±
                {x: 0, y: 0},      // 3. ç¬¬ä¸‰é€± (ä¸­é–“)
                {x: 120, y: 0},    // 4. ç¬¬å››é€±
                {x: 240, y: 0}     // 5. ç¬¬äº”é€± (æœ€å³)
            ],
            desc: "æ›¸ä¸­P.XXï¼šé æ¸¬æ•´å€‹æœˆçš„æ¯é€±é‹å‹¢èµ·ä¼ã€‚"
        },
        'single': {
            name: "å–®å¼µç‰Œå åœ",
            positions: ["æ ¸å¿ƒ"],
            layout: [{x: 0, y: 0}],
            desc: "é©åˆç°¡å–®çš„æ˜¯éé¡Œæˆ–æ¯æ—¥é‹å‹¢ã€‚"
        },
        'time': {
            name: "æ™‚é–“ä¹‹æµç‰Œé™£",
            positions: ["éå»çš„ç¶“é©—", "ç¾åœ¨çš„ç‹€æ³", "æœªä¾†çš„é æ¸¬"],
            layout: [
                {x: -120, y: 0}, 
                {x: 0, y: 0},    
                {x: 120, y: 0}   
            ],
            desc: "æª¢è¦–äº‹æƒ…çš„ä¾†é¾å»è„ˆã€‚"
        },
        'self': {
            name: "è‡ªæˆ‘æ¢ç´¢ç‰Œé™£",
            positions: ["å…§å¿ƒæ·±è™•", "ç²¾ç¥ç”Ÿæ´»", "çŸ¥è­˜é ˜åŸŸ", "æ„Ÿæƒ…ç”Ÿæ´»"],
            layout: [
                {x: 0, y: 0},      // 1. å…§å¿ƒ (ä¸­å¿ƒ)
                {x: 0, y: -250},   // 2. ç²¾ç¥ (ä¸Šæ–¹)
                {x: -200, y: 250}, // 3. çŸ¥è­˜ (å·¦ä¸‹)
                {x: 200, y: 250}   // 4. æ„Ÿæƒ… (å³ä¸‹)
            ],
            desc: "æ›¸ä¸­P.96ï¼šå…¨æ–¹ä½äº†è§£è‡ªå·±çš„èº«å¿ƒéˆç‹€æ…‹ã€‚"
        },
        'find_partner': {
            name: "å°‹æ‰¾å°è±¡å åœæ³•",
            positions: [
                "ç¾åœ¨çš„å¿ƒæƒ…å’Œè™•å¢ƒ", 
                "å¸Œæœ›è¿½æ±‚çš„é¡å‹", 
                "ä½ ä¸å–œæ­¡çš„é¡å‹", 
                "è©²æ¡å–çš„è¡Œå‹•", 
                "æœªä¾†çš„ç™¼å±•"
            ],
            // æ’åˆ—ï¼šå‘ˆ X å‹ (éª°å­5é»)ï¼Œ1åœ¨æ­£ä¸­é–“ï¼Œå…¶ä»–åœ¨å››å€‹è§’è½
            layout: [
                {x: 0, y: 0},       // 1. ä¸­å¿ƒ (ç¾æ³)
                {x: -200, y: -200}, // 2. å·¦ä¸Š (å–œæ­¡é¡å‹)
                {x: 200, y: -200},  // 3. å³ä¸Š (è¨å­é¡å‹)
                {x: -200, y: 200},  // 4. å·¦ä¸‹ (è¡Œå‹•)
                {x: 200, y: 200}    // 5. å³ä¸‹ (æœªä¾†)
            ],
            desc: "æ›¸ä¸­P.XXï¼šå°ˆç‚ºå–®èº«è€…è¨­è¨ˆï¼Œé æ¸¬æ„›æƒ…é‹å‹¢èˆ‡é©åˆå°è±¡ã€‚"
        },
        'choice': {
            name: "äºŒæ“‡ä¸€ç‰Œé™£",
            positions: ["ç¾æ³", "é¸æ“‡Açš„éç¨‹", "é¸æ“‡Bçš„éç¨‹", "é¸æ“‡Açš„çµæœ", "é¸æ“‡Bçš„çµæœ"],
            layout: [
                {x: 0, y: 150},    
                {x: -100, y: 0},       
                {x: -180, y: -120},
                {x: 100, y: 0},
                {x: 180, y: -120}  
            ],
            desc: "é¢è‡¨æŠ‰æ“‡æ™‚ä½¿ç”¨ã€‚"
        },
        // === é€²éšç‰Œé™£ ===
        'friendship': {
            name: "å‹èª¼å åœæ³•",
            positions: [
                "ä½ å°å°æ–¹çš„çœ‹æ³•", 
                "å°æ–¹å°ä½ çš„çœ‹æ³•", 
                "ä½ èªç‚ºç›®å‰é—œä¿‚", 
                "å°æ–¹èªç‚ºç›®å‰é—œä¿‚", 
                "ä½ æœŸæœ›æœªä¾†ç™¼å±•", 
                "å°æ–¹æœŸæœ›æœªä¾†ç™¼å±•"
            ],
            // æ’åˆ—ï¼šåˆ†ç‚ºä¸Šä¸‹å…©æ’ï¼Œæ¯æ’ä¸‰å¼µï¼Œä¸€ä¸€å°æ‡‰
            layout: [
                {x: -120, y: -100},  // 1. å·¦ä¸Š (ä½ çœ‹ä»–)
                {x: -120, y: 100},   // 2. å·¦ä¸‹ (ä»–çœ‹ä½ )
                {x: 0, y: -100},     // 3. ä¸­ä¸Š (ä½ èªçŸ¥çš„é—œä¿‚)
                {x: 0, y: 100},      // 4. ä¸­ä¸‹ (ä»–èªçŸ¥çš„é—œä¿‚)
                {x: 120, y: -100},   // 5. å³ä¸Š (ä½ æœŸæœ›çš„æœªä¾†)
                {x: 120, y: 100}     // 6. å³ä¸‹ (ä»–æœŸæœ›çš„æœªä¾†)
            ],
            desc: "æ›¸ä¸­P.XXï¼šé€éä¸Šä¸‹å°ç…§ï¼Œæ·±åº¦è§£æé›™æ–¹å°é€™æ®µé—œä¿‚çš„çœ‹æ³•è½å·®ã€‚"
        },
        'celtic': {
            name: "å…‹çˆ¾ç‰¹åå­—ç‰Œé™£",
            positions: [
                "ç¾æ³ (å•é¡Œçš„æ ¸å¿ƒ)", "é˜»ç¤™ (ä¸å¯é çŸ¥çš„å› ç´ )", "å…§åœ¨ (å…§å¿ƒå‹•æ©Ÿï¼Œå•é¡Œæ ¹æº)", 
                "å¤–åœ¨ (è‡ªæˆ‘çš„æœŸå¾…ï¼Œæ½›åœ¨å¯èƒ½æ€§)", "éå» (ä½ çš„ä¿¡å¿µã€å¸Œæœ›èˆ‡ææ‡¼)", "æœªä¾† (çŸ­æœŸå…§æœƒç™¼ç”Ÿçš„äº‹)", 
                "è‡ªæˆ‘ (é¢å°äº‹æƒ…çš„æ…‹åº¦)", "ç’°å¢ƒ (åˆ¥äººå°è‡ªå·±çš„çœ‹æ³•ï¼›å‘¨é­ç’°å¢ƒ)", "å¼•å°()é€™æ¬¡äº‹ä»¶è®“ä½ å­¸åˆ°ä»€éº¼", "çµæœ (å•é¡Œæœ€å¾Œçš„å±€é¢)"
            ],
            layout: [
                {x: -150, y: 0},               // 1. ç¾æ³ (åå­—ä¸­å¿ƒ)
                {x: -150, y: 0, rotate: 90},   // 2. é˜»ç¤™ (æ©«å‘äº¤å‰ï¼Œå£“åœ¨1ä¸Šé¢)
                {x: -150, y: -250},            // 3. æ½›æ„è­˜ (ä¸‹)
                {x: -150, y: 250},             // 4. éå» (å·¦)
                {x: -250, y: 0},               // 5. æ„è­˜ (ä¸Š)
                {x: 0, y: 0},                  // 6. æœªä¾† (å³)
                
                // --- å³å´æ¬Šæ–å€ ---
                {x: 180, y: 300},              // 7. è‡ªæˆ‘ (å³ä¸‹)
                {x: 180, y: 100},               // 8. ç’°å¢ƒ
                {x: 180, y: -100},              // 9. é¡˜æœ›
                {x: 180, y: -300}              // 10. çµæœ (å³ä¸Š)
            ],    
            desc: "æœ€ç¶“å…¸çš„åå¼µç‰Œé™£ï¼Œæ·±åº¦å‰–æå•é¡Œçš„å…¨è²Œã€‚"
        },
        'hexagram': {
            name: "å…­èŠ’æ˜Ÿç‰Œé™£",
            // é€™è£¡æœ‰ 7 å€‹ä½ç½®åç¨±
            positions: ["éå»", "ç¾åœ¨", "æœªä¾†", "è§£æ±ºæ–¹æ³•", "å’Œé€™å€‹äº‹æƒ…æœ‰é—œçš„äººæˆ–äº‹çš„æƒ…æ³", "é¡˜æœ›(ä½ å°šæœªç™¼è¦ºä½†å»æ˜¯ä½ å¿ƒä¸­çœŸæ­£çš„é¡˜æœ›)", "çµæœ"],
            // é€™è£¡æœ‰ 7 çµ„åº§æ¨™
            layout: [
                {x: 0, y: -200},   // 1. éå» (ä¸Šé ‚é»)
                {x: 150, y: 80},   // 2. ç¾åœ¨ (å³ä¸‹)
                {x: -150, y: 80},  // 3. æœªä¾† (å·¦ä¸‹)
                {x: 0, y: 200},    // 4. å°ç­– (ä¸‹é ‚é»)
                {x: -150, y: -80}, // 5. ç’°å¢ƒ (å·¦ä¸Š)
                {x: 150, y: -80},  // 6. é˜»ç¤™ (å³ä¸Š)
                {x: 0, y: 0}       // 7. çµæœ (æ­£ä¸­å¿ƒ)
            ],
            desc: "å…¨æ–¹ä½æ·±å…¥åˆ†æã€‚"
        },
        'lovers_pyramid': {
            name: "æˆ€äººé‡‘å­—å¡” (7å¼µ)",
            positions: [
                "ä½ å°å°æ–¹çš„æƒ³æ³•", 
                "å°æ–¹å°ä½ çš„æƒ³æ³•", 
                "ä½ å°ç›®å‰é—œä¿‚çš„çœ‹æ³•", 
                "é›™æ–¹æœ‰ç„¡çµå©šæ‰“ç®—", 
                "ä½ å¿…é ˆåšçš„è¡Œå‹•", 
                "å…©äººç›®å‰çš„é¡§æ…®", 
                "æœ€å¾Œå¯èƒ½çš„çµæœ"
            ],
            // é‡‘å­—å¡”çµæ§‹ï¼šåº•å±¤æ˜¯1ï¼Œå±¤å±¤å¾€ä¸Šå †ç–Šè‡³7
            layout: [
                {x: 0, y: 220},     // 1. åº•å±¤ (åŸºçŸ³)
                {x: -130, y: 120},  // 2. å·¦å´ (ç¬¬äºŒå±¤)
                {x: 130, y: 120},   // 3. å³å´ (ç¬¬äºŒå±¤)
                {x: 0, y: 20},      // 4. ä¸­é–“ (æ ¸å¿ƒ)
                {x: -130, y: -80},  // 5. å·¦ä¸Š (è¡Œå‹•)
                {x: 130, y: -80},   // 6. å³ä¸Š (é¡§æ…®)
                {x: 0, y: -180}     // 7. å¡”é ‚ (çµæœ)
            ],
            desc: "æ›¸ä¸­P.84ï¼šé æ¸¬å…©äººç™¼å±•å¯èƒ½æ€§èˆ‡çµå©šæ©Ÿç‡çš„æµè¡Œç‰Œé™£ã€‚"
        },
        'karmic': {
            name: "å¡çˆ¾ç±³å…‹å±•é–‹æ³• ",
            positions: [
                "ä½ çš„å®¿å‘½", 
                "ä½ çš„å€‹æ€§ ", 
                "å½±éŸ¿ä¸€è¼©å­çš„é‡å¤§äº‹ä»¶", 
                "é€™è¼©å­çš„ç¬¬äºŒç¨®å½±éŸ¿", 
                "ä½ ä¾†é€™ä¸–ç•Œçš„ç›®çš„", 
                "é€™è¼©å­èƒ½å®Œæˆç”šéº¼", 
                "é€™è¼©å­å¯ä»¥å­¸åˆ°ç”šéº¼"
            ],
            // æ’åˆ—ï¼šä¸Šä¸‹åˆ†å±¤ï¼Œä¸­é–“æ ¸å¿ƒã€‚
            // 1,2åœ¨å³ä¸‹ï¼Œ3,4åœ¨å·¦ä¸‹ï¼Œ5,6åœ¨ä¸Šæ–¹ï¼Œ7åœ¨æ­£ä¸­é–“
            layout: [
                {x: 180, y: 180},   // 1. å³ä¸‹å¤– (å®¿å‘½)
                {x: 100, y: 180},   // 2. å³ä¸‹å…§ (å€‹æ€§)
                {x: -180, y: 180},  // 3. å·¦ä¸‹å¤– (äº‹ä»¶)
                {x: -100, y: 180},  // 4. å·¦ä¸‹å…§ (å½±éŸ¿)
                {x: 100, y: -150},  // 5. å³ä¸Š (ç›®çš„)
                {x: -100, y: -150}, // 6. å·¦ä¸Š (å®Œæˆ)
                {x: 0, y: 0}        // 7. æ­£ä¸­ (å­¸ç¿’)
            ],
            desc: "æ›¸ä¸­P.XXï¼šæ¢è¨å‘½é‹èˆ‡éˆé­‚ä½¿å‘½çš„æ·±åˆ»ç‰Œé™£ã€‚"
        },
        'future': {
            name: "æœªä¾†ç™¼å±•å åœæ³• ",
            positions: [
                "ç›®å‰çš„è™•å¢ƒ", 
                "æ„›æƒ…çš„ç™¼å±•", 
                "äº‹æ¥­çš„ç™¼å±•", 
                "è²¡é‹çš„ç™¼å±•", 
                "ä½ çš„æˆå°±", 
                "æœ€å¾Œçš„çµæœ"
            ],
            // æ’åˆ—å½¢ç‹€ï¼šä»¥ç¾æ³ç‚ºä¸­å¿ƒï¼Œå‘å››æ–¹æ“´å±•ï¼Œæœ€å¾ŒæŒ‡å‘çµæœ
            layout: [
                {x: 0, y: -250},       // 1. ç¾æ³ (æ­£ä¸­å¿ƒ)
                {x: -250, y: -100},    // 2. éšœç¤™ (å·¦ - é˜»åŠ›)
                {x: 250, y: -100},    // 3. ç†æƒ³ (ä¸Š - ä»°æœ›)
                {x: -250, y: 100},     // 4. åŸºç¤ (ä¸‹ - æ ¹åŸº)
                {x: 250, y: 100},     // 5. è¿‘æœŸ (å³ - æ¨é€²)
                {x: 0, y: 250}      // 6. çµæœ (æœ€å³ - çµ‚é»)
            ],
            desc: "æ›¸ä¸­P.XXï¼šåˆ†æäº‹ä»¶ç™¼å±•è„ˆçµ¡èˆ‡æœ€çµ‚çµæœçš„å¯¦ç”¨ç‰Œé™£ã€‚"
        },
        'love_real': {
            name: "æ„›æƒ…çœŸå¿ƒå åœæ³•",
            positions: [
                "ä½ çš„çœ‹æ³•", "å°æ–¹å°ä½ çš„çœ‹æ³•", 
                "å…©äººé—œä¿‚è®ŠåŒ–å°ä½ çš„å½±éŸ¿", "å…©äººé—œä¿‚è®ŠåŒ–å°å°æ–¹çš„å½±éŸ¿", 
                "ä½ æœªä¾†çš„å¿ƒæƒ…", "æœ€å¾Œçµæœ", 
                "æœªä¾†çš„éšœç¤™", "å°æ–¹æœªä¾†çš„å¿ƒæƒ…"
            ],
            layout: [
                {x: -150, y: -120}, {x: 150, y: -120},
                {x: -0, y: -300},    {x: 0, y: -50},
                {x: -0, y: 100},  {x: 0, y: 200},
                {x: -140, y: 100},    {x: 140, y: 100}
            ],
            desc: "æ›¸ä¸­P.96ï¼šæ·±åº¦å‰–æé›™æ–¹å¿ƒæ„èˆ‡æœªä¾†ç™¼å±•ã€‚"
        }
    };

    let currentSpreadKey = 'single'; // é è¨­ç‰Œé™£
    let drawnCount = 0;
    let drawnResults = []; 
    
    // --- åˆ‡æ›é¸å–®é‚è¼¯ (é›™é¸å–®äº’æ–¥) ---
    function changeSpread(source) {
        const basicSelect = document.getElementById('spreadBasic');
        const advSelect = document.getElementById('spreadAdv');

        if (source === 'basic') {
            // å¦‚æœé¸äº†åŸºç¤ï¼Œå°±æŠŠé€²éšé¸å–®æ­¸é›¶
            advSelect.value = "";
            currentSpreadKey = basicSelect.value;
        } else if (source === 'adv') {
            // å¦‚æœé¸äº†é€²éšï¼Œå°±æŠŠåŸºç¤é¸å–®æ­¸é›¶
            basicSelect.value = "";
            currentSpreadKey = advSelect.value;
        }

        resetGameDataOnly();
    }

    // --- åˆå§‹åŒ– ---
    function init() {
        const table = document.getElementById('tableArea');
        table.innerHTML = "";
        cardsDOM = [];
        
        // é è¨­é †åº
        shuffledDeck = Array.from({length: TOTAL_CARDS}, (_, i) => i);

        for (let i = 0; i < TOTAL_CARDS; i++) {
            const el = document.createElement('div');
            el.className = 'card';
            el.dataset.index = i;
            // åˆå§‹ä½ç½®æ­¸é›¶
            el.style.setProperty('--tx', '0px');
            el.style.setProperty('--ty', '0px');
            el.style.setProperty('--rot', '0deg');
            el.style.zIndex = i;
            
            el.innerHTML = `<div class="card-inner"><div class="front"></div><div class="back"></div></div>`;
            el.onclick = () => onCardClick(el);
            table.appendChild(el);
            cardsDOM.push(el);
        }
        
        // æ›´æ–°ç‹€æ…‹æ–‡å­—
        const spreadInfo = SPREAD_DATA[currentSpreadKey];
        if(spreadInfo) {
             updateStatus(`ç›®å‰æ¨¡å¼ï¼š${spreadInfo.name}ã€‚è«‹å…ˆé¸æ“‡ã€Œå åœé¢å‘ã€ä¸¦é»æ“Šã€Œæ´—ç‰Œã€`);
        } else {
             updateStatus("è«‹é»æ“Šã€Œæ´—ç‰Œã€é–‹å§‹å„€å¼");
        }
    }

    function resetGameDataOnly() {
        drawnCount = 0;
        drawnResults = [];
        hasDrawn = false;
        isSpread = false;
        // é‡æ–°ç”Ÿæˆ DOM ä»¥é‡ç½®æ‰€æœ‰å¡ç‰‡ç‹€æ…‹
        init(); 
        document.getElementById('btnShuffle').style.display = 'inline-block';
        document.getElementById('btnSpread').style.display = 'inline-block';
        document.getElementById('btnSpread').disabled = true; // æ´—ç‰Œå‰ä¸èƒ½å±•é–‹
        document.getElementById('btnShuffle').disabled = false;
        document.getElementById('btnReset').style.display = 'none';
    }

    // --- æ´—ç‰Œé‚è¼¯ ---
    function internalShuffle() {
        // Fisher-Yates æ´—ç‰Œ
        for (let i = shuffledDeck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledDeck[i], shuffledDeck[j]] = [shuffledDeck[j], shuffledDeck[i]];
        }
    }

    async function startRitual() {
        document.getElementById('btnShuffle').disabled = true;
        updateStatus("æ­£åœ¨æ‰“äº‚ç‰Œé™£...");
        
        internalShuffle(); // é‚è¼¯æ´—ç‰Œ

        await animateMessyShuffle();
        updateStatus("æ•´ç†ç‰Œå †...");
        await animateGather();
        updateStatus("åˆ‡ç‰Œ...");
        await animateCutDeck();
        updateStatus("ç‰Œå †å·²æ·¨åŒ–ï¼Œè«‹é»æ“Šã€Œå±•é–‹ã€");
        document.getElementById('btnSpread').disabled = false;
    }

    function animateMessyShuffle() {
        return new Promise(resolve => {
            cardsDOM.forEach(card => {
                const tx = (Math.random() - 0.5) * window.innerWidth * 0.8;
                const ty = (Math.random() - 0.5) * window.innerHeight * 0.6;
                const rot = (Math.random() - 0.5) * 720;
                card.style.setProperty('--tx', tx + 'px');
                card.style.setProperty('--ty', ty + 'px');
                card.style.setProperty('--rot', rot + 'deg');
            });
            setTimeout(resolve, 1000);
        });
    }

    function animateGather() {
        return new Promise(resolve => {
            cardsDOM.forEach((card, index) => {
                card.style.setProperty('--tx', '0px');
                card.style.setProperty('--ty', -index * 0.2 + 'px');
                card.style.setProperty('--rot', '0deg');
                card.style.zIndex = index;
            });
            setTimeout(resolve, 800);
        });
    }
    
    function animateCutDeck() {
        return new Promise(resolve => {
            const cutIndex = Math.floor(TOTAL_CARDS / 2);
            cardsDOM.forEach((card, i) => {
                if(i >= cutIndex) {
                    card.style.setProperty('--tx', '120px');
                    card.style.setProperty('--ty', -i * 0.2 + 'px');
                    card.style.setProperty('--rot', '5deg');
                } else {
                    card.style.setProperty('--tx', '-120px');
                    card.style.setProperty('--ty', -i * 0.2 + 'px');
                    card.style.setProperty('--rot', '-5deg');
                }
            });
            setTimeout(() => {
                cardsDOM.forEach((card, index) => {
                    card.style.setProperty('--tx', '0px');
                    card.style.setProperty('--ty', -index * 0.2 + 'px');
                    card.style.setProperty('--rot', '0deg');
                });
                setTimeout(resolve, 800);
            }, 800);
        });
    }

    function spreadDeck() {
        isSpread = true;
        document.getElementById('btnSpread').disabled = true;
        document.getElementById('btnShuffle').style.display = 'none';
        document.getElementById('btnSpread').style.display = 'none';
        
        const isMobile = window.innerWidth < 600;
        const angleRange = isMobile ? 100 : 140; 
        const radius = isMobile ? 300 : 500; 
        const yOffset = isMobile ? 250 : 350;
        const startAngle = -(angleRange / 2); 
        const step = angleRange / (TOTAL_CARDS - 1);

        cardsDOM.forEach((card, index) => {
            const angle = startAngle + (index * step);
            const radian = angle * (Math.PI / 180);
            const x = radius * Math.sin(radian);
            const y = -radius * Math.cos(radian) + yOffset; 
            
            card.classList.add('spread'); 
            
            // æ‰‡å½¢å±•é–‹æ™‚ï¼Œåªéœ€è¦ç°¡å–®çš„æ—‹è½‰èˆ‡ä½ç§»
            card.style.setProperty('--tx', x + 'px');
            card.style.setProperty('--ty', y + 'px');
            card.style.setProperty('--rot', angle + 'deg');
            card.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
            
            card.style.zIndex = index;
        });

        // æç¤ºç¬¬ä¸€å¼µç‰Œ
        const spreadInfo = SPREAD_DATA[currentSpreadKey];
        updateStatus(`è«‹æ†‘ç›´è¦ºæŠ½å‡ºç¬¬ 1 å¼µç‰Œï¼šã€${spreadInfo.positions[0]}ã€‘`);
    }

    // --- æ ¸å¿ƒï¼šé»æ“ŠæŠ½ç‰Œ (å«åº§æ¨™é£›è¡Œé‚è¼¯) ---
    function onCardClick(card) {
        if (isAnimating) return;

        // 1. å¦‚æœé»æ“Šå·²ç¿»é–‹çš„ç‰Œ -> é¡¯ç¤ºè©³ç´°è§£é‡‹
        if (card.classList.contains('flipped')) {
            const resultIndex = parseInt(card.dataset.drawnIndex); 
            currentResult = drawnResults[resultIndex];
            showModal();
            return;
        }

        // 2. æª¢æŸ¥ç‰Œé™£ä¸Šé™
        const spreadInfo = SPREAD_DATA[currentSpreadKey];
        if (drawnCount >= spreadInfo.positions.length) {
            updateStatus("ç‰Œé™£å·²æ»¿ï¼Œè«‹é»æ“Šå·²ç¿»é–‹çš„ç‰ŒæŸ¥çœ‹è§£é‡‹ã€‚");
            return;
        }

        if (!isSpread || hasDrawn) {
            if(!isSpread) return;
        }
        
        // 3. åŸ·è¡ŒæŠ½ç‰Œ
        isAnimating = true;
        
        const cardDOMIndex = parseInt(card.dataset.index);
        const drawId = shuffledDeck[cardDOMIndex]; 
        const isReversed = Math.random() < 0.5;

        const currentPosName = spreadInfo.positions[drawnCount];
        const currentLayout = spreadInfo.layout[drawnCount]; 

        let data = null;
        if (typeof getCardData === 'function') {
            data = getCardData(drawId);
        } else {
            data = { name: "è³‡æ–™è®€å–å¤±æ•—", id: drawId };
        }

        drawnResults.push({
            id: drawId,
            name: data.name,
            isReversed: isReversed,
            positionName: currentPosName,
            index: drawnCount
        });

// ... (å‰é¢ç¨‹å¼ç¢¼ä¿æŒä¸è®Š) ...

        card.dataset.drawnIndex = drawnCount;
        card.classList.remove('spread');
        card.classList.add('drawn');
        
        // â˜…â˜…â˜… ä¿®æ”¹è™•ï¼šæ‰‹æ©Ÿç‰ˆå°ºå¯¸å„ªåŒ– â˜…â˜…â˜…
        const isMobile = window.innerWidth < 600;
        
        // 1. ç‰Œèˆ‡ç‰Œçš„é–“è· (ç¸®å°é–“è·ï¼Œè®“ç‰Œé™£æ›´ç·Šæ¹Š)
        // æ‰‹æ©Ÿç‰ˆæ”¹ç‚º 0.45 å€ï¼Œé›»è…¦ç‰ˆç¶­æŒ 1 å€
        const spaceScale = isMobile ? 0.45 : 1; 
        
        const finalX = currentLayout.x * spaceScale;
        const finalY = currentLayout.y * spaceScale;

        // 2. ç‰Œæœ¬èº«çš„æ”¾å¤§å€ç‡
        // æ‰‹æ©Ÿç‰ˆå¾ 1.15 æ”¹ç‚º 0.85 (è®“ç‰Œçœ‹èµ·ä¾†å°å·§ç²¾ç·»)
        const sizeScale = isMobile ? 0.85 : 1.4; 

        // 3. åº§æ¨™å®šä½ (åŠ å…¥æ—‹è½‰èˆ‡å¤§å°)
        let rotateDeg = 0;
        if (currentLayout.rotate) {
            rotateDeg = currentLayout.rotate;
        }
        
        card.style.transform = `translate(calc(-50% + ${finalX}px), calc(-50% + ${finalY}px)) rotate(${rotateDeg}deg) scale(${sizeScale})`;
        card.style.zIndex = 100 + drawnCount;
        
        // ... (å¾Œé¢ç¨‹å¼ç¢¼ä¿æŒä¸è®Š) ...

        updateStatus(`è§£è®€ä¸­ï¼š${currentPosName}...`);

        setTimeout(() => {
            const backDiv = card.querySelector('.back');
            const imgPath = `images/${drawId}.jpg`;

            backDiv.innerHTML = `
                <div class="back-img-container">
                    <img src="${imgPath}" style="${isReversed ? 'transform: rotate(180deg)' : ''}" onerror="this.src='https://via.placeholder.com/300x525?text=${encodeURIComponent(data.name)}'">
                </div>
                <div class="back-text">
                    <div style="font-size:12px; color:#d4af37; margin-bottom:2px;">[${drawnCount+1}] ${currentPosName}</div>
                    <div class="card-name-text">${data.name}</div>
                </div>
            `;
            
            card.classList.add('flipped');
            drawnCount++;
            
            if (drawnCount < spreadInfo.positions.length) {
                updateStatus(`å·²æŠ½å‡ºã€${currentPosName}ã€‘ï¼Œä¸‹å¼µï¼šã€${spreadInfo.positions[drawnCount]}ã€‘`);
            } else {
                updateStatus("ç‰Œé™£å®Œæˆï¼è«‹é»æ“Šå„å¼µç‰ŒæŸ¥çœ‹è©³ç´°è§£è®€ã€‚");
                document.getElementById('btnReset').style.display = 'inline-block';
                hasDrawn = true;
            }
            isAnimating = false;

        }, 600);
    }

    // --- è©³ç´°è¦–çª— ---
    function showModal() {
        if(!currentResult) return;
        let data = getCardData(currentResult.id);
        if (!data) return;

        activeCardData = data;
        activeIsReversed = currentResult.isReversed;
        
        document.getElementById('modalTitle').innerHTML = 
            `<span style="font-size:0.6em; color:#d4af37; display:block;">ä½ç½® ${currentResult.index + 1}ï¼š${currentResult.positionName}</span>` + 
            data.name;

        document.getElementById('modalStatus').innerText = activeIsReversed ? "ã€é€†ä½ã€‘ Reversed" : "ã€æ­£ä½ã€‘ Upright";
        document.getElementById('modalStatus').style.color = activeIsReversed ? "#e74c3c" : "#2ecc71";
        document.getElementById('imageDescText').innerText = data.image_desc || "æš«ç„¡åœ–è§£è³‡æ–™";

        // â˜… è‡ªå‹•åˆ‡æ›é¢å‘
        const selectedCategory = document.getElementById('categorySelector').value;
        
        // æª¢æŸ¥è©²é¡åˆ¥æ˜¯å¦å­˜åœ¨
        if (activeCardData.categories && activeCardData.categories[selectedCategory]) {
            showDetail(selectedCategory);
            document.getElementById('mainView').style.display = 'none'; 
        } else {
            // è‹¥ç„¡è³‡æ–™å‰‡é¡¯ç¤ºé è¨­åœ–è§£
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('detailView').style.display = 'none';
        }
        document.getElementById('meaningModal').classList.add('active');
    }

    function showDetail(categoryKey) {
        if (!activeCardData || !activeCardData.categories || !activeCardData.categories[categoryKey]) {
            alert("æ­¤é …ç›®æš«ç„¡è©³ç´°è³‡æ–™");
            return;
        }
        const catData = activeCardData.categories[categoryKey];
        document.getElementById('detailTitle').innerText = catData.label;
        const content = activeIsReversed ? catData.reversed : catData.upright;
        
        document.getElementById('detailContent').innerHTML = `
            <div style="margin-bottom: 10px; color: #aaa; font-size: 13px;">
                ${activeIsReversed ? "â–¼ é€†ä½æŒ‡å¼•" : "â–² æ­£ä½æŒ‡å¼•"}
            </div>
            <div style="line-height: 1.8; color: #fff;">${content}</div>
        `;
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('detailView').style.display = 'block';
    }

    function backToMain() {
        document.getElementById('detailView').style.display = 'none';
        document.getElementById('mainView').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('meaningModal').classList.remove('active');
    }
    
    // é»æ“Šè¦–çª—å¤–éƒ¨é—œé–‰
    document.getElementById('meaningModal').onclick = function(e) {
        if(e.target === this) closeModal();
    }

    function resetGame() {
        location.reload();
    }

    function updateStatus(text) {
        const el = document.getElementById('statusText');
        el.innerText = text;
        el.style.opacity = 1;
    }

    // å•Ÿå‹•ç¨‹å¼
    init();
</script>
</body>
</html>